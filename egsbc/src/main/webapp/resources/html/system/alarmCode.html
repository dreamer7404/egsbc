<!-- widget grid -->
<section id="widget-grid" class="">

	<!-- row -->
	<div class="row">

		<!-- NEW WIDGET START -->
		<article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

			<!-- Widget ID (each widget will need unique ID)-->
			<div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-1" data-widget-editbutton="false">
				<header >
					<span class="widget-icon"> <i class="fa fa-table"></i> </span>
					<h2>Alarm Code </h2>
				</header>
				<!-- widget div-->
				<div class="div-widget" >
				
					<table id="dtAlarmCode" class="table table-striped table-bordered table-hover"   >
						<thead>
							<tr>
								<th class="text-center">Code</th>
								<th class="text-center">Level</th>
								<th class="text-center">Rate Limit</th>
								<th class="text-center">Alarm Message</th>
								<th class="text-center">Sound</th>
							</tr>
						</thead>
					</table>
					
					<div >&nbsp;</div>	
									
					<div style="width:100%;border-bottom:1px solid #d1d1d1;margin-bottom:15px;">
		        		<strong>Alarm Code Information</strong>
		        	</div>
					
					<div style="margin-bottom:20px">
						<form class="smart-form" id="frmAlarmCode" novalidate="novalidate">
							<table border="0">
							<tr>
								<td width="400px" style="vertical-align:top">
									
									<table border="0" style="margin:0 auto;">
									<tr>
										<td class="td-label" width="120px">Category Name</td>
										<td width="200px">
											<label class="input state-disabled">
												<input type="text" id="alarmCategoryName" >
											</label>
										</td>
									</tr>
									<tr>
										<td class="td-label">Block Name</td>
										<td >
											<label class="input state-disabled">
												<input type="text" id="blockName" >
											</label>
										</td>
									</tr>
									<tr>
										<td class="td-label">Sound</td>
										<td >
											<span class="onoffswitch" >
												<input type="checkbox"  class="onoffswitch-checkbox" id="soundOn" >
												<label class="onoffswitch-label" for="soundOn"> 
													<span class="onoffswitch-inner" data-swchon-text="ON" data-swchoff-text="OFF"></span> 
													<span class="onoffswitch-switch"></span> 
												</label> 
											</span> 
										</td>
									</tr>
									<tr>
										<td class="td-label">E-mail</td>
										<td >
<!-- 											<span class="onoffswitch" > -->
<!-- 												<input type="checkbox"  class="onoffswitch-checkbox" id="emailOn" > -->
<!-- 												<label class="onoffswitch-label" for="emailOn">  -->
<!-- 													<span class="onoffswitch-inner" data-swchon-text="ON" data-swchoff-text="OFF"></span>  -->
<!-- 													<span class="onoffswitch-switch"></span>  -->
<!-- 												</label>  -->
<!-- 											</span>  -->
												<label id="lblEmailOn"></label>
										</td>
									</tr>
<!-- 									<tr> -->
<!-- 										<td class="td-label">SMS</td> -->
<!-- 										<td > -->
<!-- 											<span class="onoffswitch" > -->
<!-- 												<input type="checkbox"  class="onoffswitch-checkbox" id="smsOn" > -->
<!-- 												<label class="onoffswitch-label" for="smsOn">  -->
<!-- 													<span class="onoffswitch-inner" data-swchon-text="ON" data-swchoff-text="OFF"></span>  -->
<!-- 													<span class="onoffswitch-switch"></span>  -->
<!-- 												</label>  -->
<!-- 											</span>  -->
<!-- 										</td> -->
<!-- 									</tr> -->
									</table>
								
								
								</td>
								<td>
									<table border="0" style="margin:0 auto;">
									<tr>
										<td class="td-label" width="150px">Alarm Type</td>
										<td width="200px">
											<label class="input state-disabled">
												<input type="text" id="alarmType">
											</label>
										</td>
										<td></td>
									</tr>
									<tr>
										<td class="td-label">Alarm threshold value</td>
										<td >
											<label class="input" name="lblClass">
												<input type="text" id="alarmLevelThresholdValue" name="alarmLevelThresholdValue">
											</label>
										</td>
										<td class="td-label"><label id="lblUnit"></label></td>
									</tr>
									<tr>
										<td class="td-label">Alarm Action</td>
										<td class="td-label" colspan="2" width="500px">
											<div class="inline-group">
												<label class="radio" name="lblClass">
													<input type="radio" name="alarmAction" value="1">
													<i></i>Alarm Only
												</label>
												<label class="radio" name="lblClass">
													<input type="radio" name="alarmAction" value="2" >
													<i></i>Drop
												</label>
												<label class="radio" name="lblClass">
													<input type="radio" name="alarmAction" value="4" >
													<i></i>Switch-over
												</label>
												<label class="radio" name="lblClass" id="rdoAlarm6">
													<input type="radio" name="alarmAction" value="6" >
													<i></i>Reboot
												</label>
												<label class="radio" name="lblClass" id="rdoAlarm7">
													<input type="radio" name="alarmAction" value="7" >
													<i></i>Power-Off
												</label>
												<label class="radio" name="lblClass" id="rdoAlarm0">
													<input type="radio" name="alarmAction" value="0" >
													<i></i>Separately defined
												</label>
											</div>
										</td>
									</tr>
									<tr>
										<td class="td-label">Alarm Name</td>
										<td >
											<label class="input state-disabled">
												<input type="text" id="alarmName" name="alarmName">
											</label>
										</td>
										<td></td>
									</tr>
									<tr>
										<td class="td-label">Alarm Message</td>
										<td colspan="2" >
											<label class="input" >
												<input type="text" id="alarmMsg" name="alarmMsg">
											</label>
										</td>
									</tr>
									<tr>
										<td class="td-label">Alarm Description</td>
										<td colspan="2">
											<label class="input">
												<input type="text" id="alarmDesc" name="alarmDesc">
											</label>
										</td>
									</tr>
									</table>
								
								</td>
							</tr>
							</table>
						</form>
						<div style="width:640px;margin-top:15px" class="form-group text-right">
							<button type="button" class="btn btn-default btn-apply" id="btnApply">Apply</button>
						</div>	
					</div>		
						
				</div>
			</div>
			
		</article>
	</div>			
</section>	
<script type="text/javascript">
var tableAlarmCode;
var validatorAlarmCode;
var g_alarmCode;
var g_selectedIndex=1;

var pagefunction = function() {
	
	tableAlarmCode = $('#dtAlarmCode').DataTable({
		"sDom": sDom,
		"oLanguage": oLanguage,
		"autoWidth" : true,
		"tableTools":tableTools,
		"scrollY" : "200px",
		"scrollX" : false,
		"scrollCollapse": true,
		"paging": false,
			"processing": true,
        "ajax": {
        	url: "/getAlarmCode",
        	type: "post"
        },
        'order': [[0, 'asc']],
        "columns": [
    				{ "data": "alarmCode"},       
    		        { "data": "alarmLevel"},	
    		        { "data": "rateLimitFlag" },	
    		        { "data": "alarmMsg" }, 	
    		        { "data": "soundOn"}, 		
    		    ],
    	'columnDefs': [	 
				{'targets': 0, 'className': 'text-center'},
				{'targets': 1, 'className': 'text-center', 'render': function (data, type, full, meta){ return getAlarmLevel(data); }},
				{'targets': 2, 'className': 'text-center', 'render': function (data, type, full, meta){ return getRateLimit(data); }},
				{'targets': 3, 'className': 'text-left'},
				{'targets': 4, 'className': 'text-center', 'render': function (data, type, full, meta){ return getOnOff(data); }},
    	 ],
    	 "initComplete": function(settings, json) {
    		 $('#dtAlarmCode tbody tr:eq(0)').click();
    	 }
	});
	//	click row
	tableAlarmCode.on( 'click', 'tr', function () {
		tableAlarmCode.$('tr.selected').removeClass('selected');
		$(this).addClass('selected');
		
		g_selectedIndex = this.rowIndex;
		showAlarmCodeInform();
	});
	//	dblclick row
	tableAlarmCode.on( 'dblclick', 'tr', function () {
		tableAlarmCode.$('tr.selected').removeClass('selected');
		$(this).addClass('selected');
		
		g_selectedIndex = this.rowIndex;
		showAlarmCodeInform();
	});
	
	
	// apply
	$('#btnApply').click(function(){
		
		if(!$('#frmAlarmCode').valid()){
			return;
		}
		
		// check not edit
		var soundOn = getControlCheck("frmAlarmCode", "soundOn")?1:0;
		//var emailOn = getControlCheck("frmAlarmCode", "emailOn")?1:0;
 		//var smsOn = 0; // getControlCheck("frmAlarmCode", "smsOn")?1:0;
		var alarmLevelThresholdValue = getControlInput("frmAlarmCode", "alarmLevelThresholdValue");
		var alarmAction = getControlRadio("frmAlarmCode", "alarmAction");
		var alarmMsg = getControlInput("frmAlarmCode", "alarmMsg");
		var alarmDesc = getControlInput("frmAlarmCode", "alarmDesc");
		
		var data = tableAlarmCode.rows('.selected').data();
		var item = data[0];
		
		if(	item.soundOn == soundOn &&
			//item.emailOn == emailOn &&
			//item.smsOn == smsOn &&
			item.alarmLevelThresholdValue == alarmLevelThresholdValue &&
			item.alarmAction == alarmAction &&
			item.alarmMsg == alarmMsg &&
			item.alarmDesc == alarmDesc){
			showMsg("Warning", "There are no values changed.");
			return;
		}
		
		// check Alarm threshold value
		if(alarmLevelThresholdValue != '' && item.alarmCode >= 301 && item.alarmCode <= 312){ 
			
			if(alarmLevelThresholdValue < 20 || alarmLevelThresholdValue > 90){
				showMsg("Warning", "Alarm threshold value range is 20 ~ 90");
				return;
			}
			
			
			if(item.alarmLevel==4){ // critical (major보다 커야)
				var major = getMajorThresholdValue(item.alarmCode+1);
				if(alarmLevelThresholdValue <= major){
					showMsg("Warning", "Critical value must be greater than major value");
					return;
				}
			}else if(item.alarmLevel==3){ // major (중간)
				var obj = getCriticalMinorThresholdValue(item.alarmCode-1, item.alarmCode+1);
				if(alarmLevelThresholdValue >= obj.critical){
					showMsg("Warning", "Major value must be less than critical value");
					return;
				}
				if(alarmLevelThresholdValue <= obj.minor){
					showMsg("Warning", "Major value must be greater than minor value");
					return;
				}
			}else if(item.alarmLevel==2){ // minor ( major보다 작아야)
				var major = getMajorThresholdValue(item.alarmCode-1);
				if(alarmLevelThresholdValue >= major){
					showMsg("Warning", "Minor value must be less than major value");
					return;
				}
			}
		}
		
		
		showConfirm('Confirm', "Do you want to apply?");
		
		$("#btnConfirm").unbind('click');
		$("#btnConfirm").click(function(){
			showLoader();
			$("#frmAlarmCode").submit();  
		});
		
	});
	
	$("#frmAlarmCode").ajaxForm({
		url: "/setAlarmCode",
		type: "POST",
		beforeSubmit: function(arr, $form, options){
			// alarm code
			arr.push({name:'alarmCode', value: g_alarmCode});
			// checkbox
			var soundOn = getControlCheck("frmAlarmCode", "soundOn")?1:0;
			
			var item = tableAlarmCode.rows('.selected').data()[0];
			
			var emailOn = item.emailOn; //getControlCheck("frmAlarmCode", "emailOn")?1:0;
			var smsOn = item.smsOn;; //getControlCheck("frmAlarmCode", "smsOn")?1:0;
			
			arr.push({name:'soundOn', value: soundOn});
			arr.push({name:'emailOn', value: emailOn});
			arr.push({name:'smsOn', value: smsOn});
		},
		success: function(responseText, statusText, xhr, $form){
			//processResult(responseText.result, null, tableAlarmCode, null);
			hideConfirm();
			if(responseText.result==1){
				tableAlarmCode.ajax.reload(null, false);
				setTimeout(function(){
					 $('#dtAlarmCode tbody tr:eq('+(g_selectedIndex-1)+')').click();
				},500);
			}else{
				showMsg("Error", "Fail, Apply data!");
			}
		}
	});
	
	
	validatorAlarmCode = $('#frmAlarmCode').validate({
		rules : {
			alarmLevelThresholdValue:{ 
				number: true
			}
		},
		messages : {
			alarmLevelThresholdValue:{ 
				number : 'Input numeric'
 			}
		},
		errorPlacement : function(error, element) {
			error.insertAfter(element.parent());
		}
	});

} // pagefunction

$('body').append( $('<div>').load("/resources/html/common.html"));

loadScript("/resources/js/plugin/datatables/jquery.dataTables.min.js", function(){
	loadScript("/resources/scripts/common/dataTables.js", function(){
		loadScript("/resources/scripts/common/controls.js", pagefunction);
	});
});

function getRateLimit(val){
	if(val==0) return "NO";
	else if(val==1) return "YES";
	else return "";
}

function showAlarmCodeInform(){
	var data = tableAlarmCode.rows('.selected').data();
	var item = data[0];
	//alert(item.alarmCode);
	//setControlInput("frmAlarmCode", "alarmCode", item.alarmCode, true);
	g_alarmCode = item.alarmCode;
	
	setControlInput("frmAlarmCode", "alarmCategoryName", item.alarmCategoryName, true);
	setControlInput("frmAlarmCode", "blockName", item.blockName, true);
	
	
	setControlCheck("frmAlarmCode", "soundOn", (item.soundOn==0)?false:true, false); // sound
//	setControlCheck("frmAlarmCode", "emailOn", (item.emailOn==0)?false:true, true); // email
	$("#frmAlarmCode #lblEmailOn").html((item.emailOn==0)?"Off":"On");
// 	setControlCheck("frmAlarmCode", "smsOn", (item.smsOn==0)?false:true, false); // sms
	
	
 	if(item.rateLimitFlag==1){ //Rate-limit가 YES 경우 , separately defined 이고 수정 불가
 		$("#frmAlarmCode [name=lblClass]").addClass("state-disabled");
 		
 		setControlInput("frmAlarmCode", "alarmType", getAlarmType(0), true);
 		setControlInput("frmAlarmCode", "alarmLevelThresholdValue", "separately defined", true); 
 		setControlRadio("frmAlarmCode", "alarmAction", 0, true);
 		
 	}else{  							
 		$("#frmAlarmCode [name=lblClass]").removeClass("state-disabled");
 		
 		setControlInput("frmAlarmCode", "alarmType", getAlarmType(item.alarmType), true);
 		setControlInput("frmAlarmCode", "alarmLevelThresholdValue", item.alarmLevelThresholdValue, false);
 		setControlRadio("frmAlarmCode", "alarmAction", item.alarmAction, false);
 	}
 	
 	// Alarm Action 표시여부
 	if(item.alarmCode >= 301 && item.alarmCode <= 309){
		$("#rdoAlarm6").show();
		$("#rdoAlarm7").show();
		$("#rdoAlarm0").hide();
	}else{
		$("#rdoAlarm6").hide();
		$("#rdoAlarm7").hide();
		$("#rdoAlarm0").show();
	}
 	
 	// 단위표시
 	if(item.alarmCode >= 301 && item.alarmCode <= 309){
 		$("#lblUnit").text("%");
 	}else if(item.alarmCode >= 310 && item.alarmCode <= 312){
 		$("#lblUnit").text("℃");
 	}else{
 		$("#lblUnit").text("");
 	}
		
 	
 	
	
	setControlInput("frmAlarmCode", "alarmName", item.alarmName, true);
	setControlInput("frmAlarmCode", "alarmMsg", item.alarmMsg, false);
	setControlInput("frmAlarmCode", "alarmDesc", item.alarmDesc, false);
}
// 0: separately, 1: not display, 2: display only, 3:click for clear, 5: clear by block  

function getAlarmType(val){
	if(val==0) return "separately defined";
	else if(val==1) return "not display";
	else if(val==2) return "display only";
	else if(val==3) return "click for clear";
	else if(val==5) return "clear by block";
	else return "";
}

function getMajorThresholdValue(alarmCode){
	var alarmLevelThresholdValue;
	tableAlarmCode.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
		var data = this.data();
		if(data.alarmCode == alarmCode){
			alarmLevelThresholdValue= data.alarmLevelThresholdValue;
		}
	});
	return alarmLevelThresholdValue;
}

function getCriticalMinorThresholdValue(alarmCode1, alarmCode2){
	var obj={};
	tableAlarmCode.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
		var data = this.data();
		if(data.alarmCode == alarmCode1){
			obj.critical = data.alarmLevelThresholdValue;
		}else if(data.alarmCode == alarmCode2){
			obj.minor = data.alarmLevelThresholdValue;
		}
	});
	return obj;
}

</script>