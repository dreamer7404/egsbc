<!-- widget grid -->
<section id="widget-grid" class="">

	<!-- row -->
	<div class="row">

		<!-- NEW WIDGET START -->
		<article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

			<!-- Widget ID (each widget will need unique ID)-->
			<div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-1" data-widget-editbutton="false">
				<header >
					<span class="widget-icon"> <i class="fa fa-table"></i> </span>
					<h2>NAT History</h2>
				</header>
				<!-- widget div-->
				<div class="div-widget" >
				
					<form class="smart-form" id="frmNatHistorySearch"  novalidate="novalidate">
						<table border="0" width="100%">
						<tr>
							<td class="td-label" width="120px">Start ~ End Time</td>
							<td width="280px">
								<label class="input" >
										<input class="form-control"  type="text" id="dateTime" >
									</label>
							</td>
							<td  align="left" style="padding-left:20px">
								<button type="button" class="btn btn-default btn-search"  id="btnSearch">Search</button>
							</td>
						</tr>
						</table>
					</form>
					
					<div>
					<table id="dtNatHistory" class="table table-striped table-bordered table-hover"   >
						<thead>
							<tr>
								<th rowspan="2" class="text-center">Service Name</th>
								<th rowspan="2" class="text-center">Time</th>
								<th rowspan="2" class="text-center">Desc</th>
								<th colspan="2" class="text-center">In Side</th>
								<th colspan="2" class="text-center">Out Side</th>
							</tr>
							<tr>
								<th class="text-center">source ip:port</th>
								<th class="text-center">destination ip:port</th>
								<th class="text-center">source ip:port</th>
								<th class="text-center">destination ip:port</th>
							</tr>	
						</thead>
					</table>
					
					</div>
					
					<div class="form-group text-right">
						&nbsp;
					</div>
					
					<form class="smart-form" novalidate="novalidate">
							<table border="0" width="100%">
							<tr>
								<td width="40px">Show</td>
								<td width="60px">
										<label class="select" > 
											<select  id="pageSize"> 
												<option value="10" selected>10</option> 
												<option value="20">20</option> 
												<option value="30">30</option> 
												<option value="50">50</option> 
											</select> <i></i> 
			 							</label>
		 							</div>
								</td>
								<td width="40px">entries</td>
								<td align="center" >
									<ul class="pagination pagination-sm" id="ulPage"></ul>
								</td>
								<td width="140px">
								&nbsp;
								</td>
							</tr>
							</table>
						</form>
					
					<div >&nbsp;</div>	
							
					<div id="divNatHistoryDetail" style="display:none">			
									
						<div style="width:100%;border-bottom:1px solid #d1d1d1;margin-bottom:15px;">
			        		<strong>Nat History Information</strong>
			        	</div>
						
						<div style="margin-bottom:20px">
							<form class="smart-form" id="frmNatHistory" novalidate="novalidate">
								<table border="0">
								<tr>
									<td width="400px" style="vertical-align:top">
										
										<table border="0" style="margin:0 auto;">
										<tr>
											<td class="td-label" width="120px">Proxy Mode</td>
											<td width="300px">
												<span class="onoffswitch" >
													<input type="checkbox"  class="onoffswitch-checkbox" id="proxyMode" >
													<label class="onoffswitch-label" for="proxyMode"> 
														<span class="onoffswitch-inner" data-swchon-text="ON" data-swchoff-text="OFF"></span> 
														<span class="onoffswitch-switch"></span> 
													</label> 
												</span> 
											</td>
										</tr>
										<tr>
											<td class="td-label">IPKTS Mode</td>
											<td width="200px">
												<span class="onoffswitch" >
													<input type="checkbox"  class="onoffswitch-checkbox" id="ipkts" >
													<label class="onoffswitch-label" for="ipkts"> 
														<span class="onoffswitch-inner" data-swchon-text="ON" data-swchoff-text="OFF"></span> 
														<span class="onoffswitch-switch"></span> 
													</label> 
												</span> 
											</td>
										</tr>
										<tr>
											<td class="td-label">Protocol</td>
											<td width="200px">
												<div class="inline-group">
													<label class="radio">
														<input type="radio" name="protocol" value="3">
														<i></i>All
													</label>
													<label class="radio">
														<input type="radio" name="protocol" value="1" checked>
														<i></i>UDP
													</label>
													<label class="radio">
														<input type="radio" name="protocol" value="2" >
														<i></i>TCP
													</label>
												</div>
											</td>
										</tr>
										<tr>
											<td class="td-label">Packets per Sec.</td>
											<td width="200px">
												<label class="input">
													<input type="text" id="maxPacketPerSec">
												</label>
											</td>
										</tr>
										<tr>
											<td class="td-label">핀홀유지시간</td>
											<td width="200px">
												<label class="input">
													<input type="text" id="pineHoleDuration">
												</label>
											</td>
										</tr>
										</table>
										
									</td>
									<td style="vertical-align:top">
										<table border="0" style="margin:0 auto;">
										<tr>
											<td class="td-label" width="150px">In side Rx/Tx/Drop</td>
											<td width="100px">
												<label class="input">
													<input type="text" id="inMatchCount">
												</label>
											</td>
											<td>&nbsp;/&nbsp;</td>
											<td width="100px">
												<label class="input">
													<input type="text" id="inMatchRelay">
												</label>
											</td>
											<td>&nbsp;/&nbsp;</td>
											<td width="100px">
												<label class="input">
													<input type="text" id="inMatchDrop">
												</label>
											</td>
										</tr>
										<tr>
											<td class="td-label" width="150px">Out side Rx/Tx/Drop</td>
											<td width="100px">
												<label class="input">
													<input type="text" id="outMatchCount">
												</label>
											</td>
											<td>&nbsp;/&nbsp;</td>
											<td width="100px">
												<label class="input">
													<input type="text" id="outMatchRelay">
												</label>
											</td>
											<td>&nbsp;/&nbsp;</td>
											<td width="100px">
												<label class="input">
													<input type="text" id="outMatchDrop">
												</label>
											</td>
										</tr>
										</table>	
									</td>
								</tr>
								</table>
							</form>
						</div>
					</div>						
				</div>
			</div>
			
		</article>
	</div>			
</section>	
<script type="text/javascript">
var tableNatHistory;
var page=1;
var g_natHistoryInterval;

var pagefunction = function() {
	
	g_natHistoryInterval = setInterval(function(){ 
		var now = $("#systemDateTime").text();
		if(now != ''){
			clearInterval(g_natHistoryInterval);
			init(); 
		}
	},200);
	
	// serarch
	$("#btnSearch").click(function(){
		tableNatHistory.ajax.reload(null, false);	
		
		setTimeout(function(){
			showDetail();
		},500);
		
	});
	
	
} // pagefunction

function init(){
	
	// date rage setting
	$('#dateTime').daterangepicker({
		 timePicker: true, 
		 timePickerIncrement: 1,
		 locale: { 
			 format: 'YYYY-MM-DD HH:mm:ss' 
		 } 
	});
	
	// set range date
	var now = moment($("#systemDateTime").text(), 'YYYY.MM.DD HH:mm:ss');
	$('#dateTime').data('daterangepicker').setEndDate(now.format('YYYY.MM.DD HH:mm:ss'));
	$('#dateTime').data('daterangepicker').setStartDate(now.add(-1, 'hour').format('YYYY-MM-DD HH:mm:ss'));
	
	
	tableNatHistory = $('#dtNatHistory').DataTable({
		"sDom": sDomNoControl,
		"oLanguage": oLanguage,
		"autoWidth" : true,
		"tableTools":tableTools,
		"scrollY" : false,
		"scrollX" : false,
		"scrollCollapse": true,
		"paging": false,
		"processing": true,
        "ajax": {
        	url: "/getNatHistory",
        	type: "post",
        	data: function(d){
        		d.page=page;
        		d.pageSize=$("#pageSize").val();
          		//d.startDate = '2016-07-19 04:59:22'; 
       			//d.endDate = '2016-07-20 02:12:20';
     			d.startDate = $('#dateTime').data('daterangepicker').startDate.format('YYYY-MM-DD HH:mm:ss');
     			d.endDate = $('#dateTime').data('daterangepicker').endDate.format('YYYY-MM-DD HH:mm:ss');
        	}
        },
        'order': [[1, 'desc']],
        "columns": [
    				{ "data": "natSvcName"},       
    		        { "data": "createDatetime"},	
    		        { "data": "eventCode" },	
    		        { "data": "inSrcIp" }, 	
    		        { "data": "inDstIp"}, 		
    		        { "data": "outSrcIp" }, 	
    		        { "data": "outDstIp"}, 		
    		    ],
    	'columnDefs': [	 
				{'targets': 0, 'className': 'text-center'},
				{'targets': 1, 'className': 'text-center', 'render': function (data, type, full, meta){ return getDatetime(data); }},
				{'targets': 2, 'className': 'text-center', 'render': function (data, type, full, meta){ return getEventCode(data); }},
				{'targets': 3, 'className': 'text-center', 'render': function (data, type, full, meta){ return data + ":" + full.inSrcPort }},
				{'targets': 4, 'className': 'text-center', 'render': function (data, type, full, meta){ return data + ":" + full.inDstPort }},
				{'targets': 5, 'className': 'text-center', 'render': function (data, type, full, meta){ return data + ":" + full.outSrcPort }},
				{'targets': 6, 'className': 'text-center', 'render': function (data, type, full, meta){ return data + ":" + full.outDstPort }},
    	 ],
    	 "initComplete": function(settings, json) {
    		 //var cnt = $('#dtNatHistory tr:last').index();
    		 showDetail();
    	 }
	});
	//	click row
	tableNatHistory.on( 'click', 'tr', function () {
		tableNatHistory.$('tr.selected').removeClass('selected');
		$(this).addClass('selected');
		
		showNatHistory();
	});
	//	dblclick row
	tableNatHistory.on( 'dblclick', 'tr', function () {
		tableNatHistory.$('tr.selected').removeClass('selected');
		$(this).addClass('selected');
		
		showNatHistory();
	});
	
	// pagenation, cnt
	tableNatHistory.on( 'xhr', function () {
	    var json = tableNatHistory.ajax.json();
	    showPagenation(json.vo);
// 		$("div.cnt").html("Subscribers Count: " + json.vo.subscriberCntReg + " / " + json.vo.subscriberCntAll);
// 		 $('#dateTime').data('daterangepicker').setStartDate(getDatetime(json.vo.date1));
// 		 $('#dateTime').data('daterangepicker').setEndDate(getDatetime(json.vo.date2));
	    
	} );
	
}	



$('body').append( $('<div>').load("/resources/html/common.html"));

loadScript("/resources/js/plugin/datatables/jquery.dataTables.min.js", function(){
	loadScript("/resources/scripts/common/dataTables.js", function(){
		loadScript("/resources/scripts/common/controls.js", pagefunction);
	});
});

function showDetail(){
	 var data = tableNatHistory.rows(0).data();
	 if(typeof data[0] !='undefined'){
		 $("#divNatHistoryDetail").show();
		 $('#dtNatHistory tbody tr:eq(0)').click();
	 }else{
		 $("#divNatHistoryDetail").hide();
	 }
}



function showNatHistory(){
	var data = tableNatHistory.rows('.selected').data();
	var item = data[0];
	
 	setControlCheck("frmNatHistory", "proxyMode", (item.proxyMode==0)?false:true, false); 
	setControlCheck("frmNatHistory", "ipkts", (item.ipkts==0)?false:true, false); 
	setControlRadio("frmNatHistory", "protocol", item.protocol, false);
	
	setControlInput("frmNatHistory", "maxPacketPerSec", item.maxPacketPerSec, false);
	setControlInput("frmNatHistory", "pineHoleDuration", item.pineHoleDuration, false);
	
	setControlInput("frmNatHistory", "inMatchCount", item.inMatchCount, false);
	setControlInput("frmNatHistory", "inMatchRelay", item.inMatchRelay, false);
	setControlInput("frmNatHistory", "inMatchDrop", item.inMatchDrop, false);
	
	setControlInput("frmNatHistory", "outMatchCount", item.outMatchCount, false);
	setControlInput("frmNatHistory", "outMatchRelay", item.outMatchRelay, false);
	setControlInput("frmNatHistory", "outMatchDrop", item.outMatchDrop, false);
	
}

function getEventCode(val){
	if(val==30) return "add";
	else if(val==31) return "delete";
	else if(val==32) return "expired";
	else if(val==34) return "dst flood occur";
	else if(val==35) return "dst flood clear";
	else if(val==36) return "src flood occur";
	else if(val==37) return "src flood clear";
	else return "";
}

//--------------------- page ----------------------------------------------------------------------------------
function showPagenation(vo){ //page, totalPages, pageLength){
	var html = '';
	if(vo.page > vo.pageLength){
		html +='<li><a href="javascript:pageListener('+(vo.pageStart-1)+')" ><i class="fa fa-chevron-left"></i></a></li>';
	}
	for(var no=vo.pageStart; no<=vo.pageEnd; no++){
		if(no==vo.page){
			html+='<li class="active"><a href="javascript:void(0);">'+no+'</a></li>';
		}else{
			html+='<li><a href="javascript:pageListener('+no+')">'+no+'</a></li>';
		}
	}
	if(vo.totalPages > vo.pageLength && vo.pageEnd < vo.totalPages ){
		html+='<li><a href="javascript:pageListener('+(vo.pageEnd+1)+')"><i class="fa fa-chevron-right"></i></a></li>';
	}
	$("#ulPage").html(html);
}
function pageListener(no){
	page = no;
	tableNatHistory.ajax.reload(null, false);
	
	setTimeout(function(){
		 //$('#dtNatHistory tbody tr:eq(0)').click();
		showDetail();
	},500);
	
}

</script>