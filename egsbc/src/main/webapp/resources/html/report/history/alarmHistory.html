<!-- widget grid -->
<section id="widget-grid" class="">

	<!-- row -->
	<div class="row">

		<!-- NEW WIDGET START -->
		<article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

			<!-- Widget ID (each widget will need unique ID)-->
			<div class="jarviswidget jarviswidget-color-blueDark" id="wid-id-1" data-widget-editbutton="false">
				<header >
					<span class="widget-icon"> <i class="fa fa-table"></i> </span>
					<h2>Alarm History</h2>
				</header>
				<!-- widget div-->
				<div class="div-widget" >
				
					<form class="smart-form" id="frmNatHistorySearch"  novalidate="novalidate">
						<table border="0" width="100%">
						<tr>
							<td class="td-label" width="30px">Level</td>
							<td width="120px">
								<label class="select">
									<select id="level">
										<option value="0">All</option>
										<option value="1">Information</option>
										<option value="2" selected>Minor</option>
										<option value="3">Major</option>
										<option value="4">Critical</option>
<!-- 										<option value="6">Clear</option> -->
									</select> <i></i> 
								</label>
							</td>
							<td class="td-label-right" width="70px">Alarm Code</td>
							<td width="150px">
									<label class="input" >
										<input type="text" id="alarmCode" value="All" style="cursor:pointer" readonly>
									</label>
							</td>
							<td class="td-label-right" width="100px">Start ~ End Time</td>
							<td width="280px">
								<label class="input" >
										<input class="form-control"  type="text" id="dateTime" >
									</label>
							</td>
							<td width="190px" style="padding-left:15px">
								<label class="input">
									<input class="form-control"  placeholder="Input Description keyword..." type="text" id="causeDescription" name="causeDescription">
								</label>	
							</td>
							<td  align="left" style="padding-left:20px">
								<button type="button" class="btn btn-default btn-search"  id="btnSearch">Search</button>
							</td>
						</tr>
						</table>
					</form>
					
					<div>
					<table id="dtAlarmHistory" class="table table-striped table-bordered table-hover"   >
						<thead>
							<tr>
								<th class="text-center">Level</th>
								<th class="text-center">Side</th>
								<th class="text-center">Block</th>
								<th class="text-center">Time</th>
								<th class="text-center">Code</th>
								<th class="text-center">Description</th>
							</tr>	
						</thead>
					</table>
					
					</div>
					
					<div class="form-group text-right">
						&nbsp;
					</div>
					
					<form class="smart-form" novalidate="novalidate">
							<table border="0" width="100%">
							<tr>
								<td width="40px">Show</td>
								<td width="60px">
										<label class="select" > 
											<select  id="pageSize"> 
												<option value="10" selected>10</option> 
												<option value="20">20</option> 
												<option value="30">30</option> 
												<option value="50">50</option> 
											</select> <i></i> 
			 							</label>
		 							</div>
								</td>
								<td width="40px">entries</td>
								<td align="center" >
									<ul class="pagination pagination-sm" id="ulPage"></ul>
								</td>
								<td width="140px">
								&nbsp;
								</td>
							</tr>
							</table>
						</form>
					
					<div >&nbsp;</div>	
					
					<div id="divAlarmHistoryDetail" style="display:none">
									
						<div style="width:100%;border-bottom:1px solid #d1d1d1;margin-bottom:15px;">
			        		<strong>Alarm Information</strong>
			        	</div>
						
						<div style="margin-bottom:20px">
							<form class="smart-form" id="frmAlarmHistory" novalidate="novalidate">
								<table border="0">
								<tr>
									<td width="400px" style="vertical-align:top">
										
										<table border="0" style="margin:0 auto;">
										<tr>
											<td class="td-label" width="120px">Rate Limit</td>
											<td width="300px">
												<span class="onoffswitch" >
													<input type="checkbox"  class="onoffswitch-checkbox" id="rateLimitProfile" >
													<label class="onoffswitch-label" for="rateLimitProfile"> 
														<span class="onoffswitch-inner" data-swchon-text="ON" data-swchoff-text="OFF"></span> 
														<span class="onoffswitch-switch"></span> 
													</label> 
												</span> 
											</td>
										</tr>
										<tr>
											<td class="td-label">Rate Limit Category</td>
											<td width="200px">
												<label class="input">
													<input type="text" id="rateLimitCategory">
												</label>
											</td>
										</tr>
										<tr>
											<td class="td-label">Alarm Cause Param</td>
											<td width="200px">
												<label class="input">
													<input type="text" id="alarmCauseParam">
												</label>
											</td>
										</tr>
										<tr>
											<td class="td-label">Cause Real Value</td>
											<td width="200px">
												<label class="input">
													<input type="text" id="alarmCauseRealValue">
												</label>
											</td>
										</tr>
										</table>
										
									</td>
									<td style="vertical-align:top">
										<table border="0" style="margin:0 auto;">
										<tr>
											<td class="td-label" width="150px">Protocol</td>
											<td width="100px">
												<label class="input">
													<input type="text" id="protocol">
												</label>
											</td>
											
										</tr>
										<tr>
											<td class="td-label" width="150px">Remote IP / Port</td>
											<td width="100px">
												<label class="input">
													<input type="text" id="remoteIp">
												</label>
											</td>
											<td>&nbsp;/&nbsp;</td>
											<td width="100px">
												<label class="input">
													<input type="text" id="remotePort">
												</label>
											</td>
										</tr>
										<tr>
											<td class="td-label" width="150px">Local IP / Port</td>
											<td width="100px">
												<label class="input">
													<input type="text" id="localIp">
												</label>
											</td>
											<td>&nbsp;/&nbsp;</td>
											<td width="100px">
												<label class="input">
													<input type="text" id="localPort">
												</label>
											</td>
										</tr>
										<tr>
											<td class="td-label" width="150px">From URI</td>
											<td colspan="3">
												<label class="input">
													<input type="text" id="fromUri">
												</label>
											</td>
											
										</tr>
										<tr>
											<td class="td-label" width="150px">To URI</td>
											<td colspan="3">
												<label class="input">
													<input type="text" id="toUri">
												</label>
											</td>
											
										</tr>
										</table>	
									</td>
								</tr>
								</table>
							</form>
						</div>	
					</div>					
				</div>
			</div>
			
		</article>
	</div>			
</section>



<div class="modal " id="modalAlarmCode" role="dialog">
    <div class="modal-dialog modal-vertical-centered"  style="width:800px">
    	<div class="modal-content">
	        <div class="modal-header " style="height:40px;padding-top:10px;color:white">
	          	Multiple Select
	          	<div class="pull-right">
	          		<button class="btn btn-xs btn-default" data-title="Close" rel="tooltip"  data-dismiss="modal" >
						 <i class="fa fa-times"></i>
					</button>
				</div>	
	        </div>
	        <div class="modal-body">
				<div class="row" style="" >
				
					<table id="dtAlarmCode" class="table table-striped table-bordered table-hover"   >
					<thead>
							<tr>
								<th><input type="checkbox"  name="select_all" id="selectAll"></th>
								<th class="text-center">Code</th>
								<th class="text-center">Level</th>
								<th class="text-center">Rate-Limit</th>
								<th class="text-center">Alarm Messge</th>
							</tr>
						</thead>
					</table>	
		        	 <div class="modal-footer" >
			        	<button type="button" class="btn btn-default btn-apply"  id="btnApplyAlarmCode">Apply</button>
			          	<button type="button" class="btn btn-default btn-close" data-dismiss="modal" >Close</button>
			        </div>
				</div> <!-- row -->	
				
			</div><!-- body -->	
		</div>
	</div>
</div>

	
<script type="text/javascript">
var tableAlarmHistory;
var tableAlarmCode;
var page=1;
var g_alarmHistoryInterval;

var pagefunction = function() {
	
	// set level
	var level = getUrlVars()["level"];
	if(typeof level != 'undefined' && level != ''){
		$("#frmNatHistorySearch #level").val(level);
	}
	
	
	
	g_alarmHistoryInterval = setInterval(function(){ 
		var now = $("#systemDateTime").text();
		if(now != ''){
			clearInterval(g_alarmHistoryInterval);
			init(); 
		}
	},200);
	
	// serarch
	$("#btnSearch").click(function(){
		tableAlarmHistory.ajax.reload(null, false);	
		
		setTimeout(function(){
			 //$('#dtAlarmHistory tbody tr:eq(0)').click();
			showDetail();
		},500);
		
	});
	
	// show alarm Code
	$("#alarmCode").click(function(){
		showModal($("#modalAlarmCode"));
		tableAlarmCode.ajax.reload(null, false);
		
		setTimeout(function(){
			var str = $("#alarmCode").val();
			if(str=="All"){
				$("input:checkbox[id='selectAll']").prop("checked", true);
				
				// check all
			 	var rows = tableAlarmCode.rows({ 'search': 'applied' }).nodes();
		     	$('input[type="checkbox"]', rows).prop('checked', true);
			}else{
				$("input:checkbox[id='selectAll']").prop("checked", false);
				
				// check by value
				var arr = str.split(',');
				for(var i=0; i<arr.length; i++){
					$("input:checkbox[value="+arr[i]+"]").prop("checked", true);
				}
			}
		},500);
		
	});
	
	// btnApplyAlarmCode
	$("#btnApplyAlarmCode").click(function(){
		var str="";
		//var selectAll = $("input:checkbox[id='selectAll']").is(":checked"); 
		var selectAll = $("#selectAll").is(":checked"); 
		if(selectAll){
			str="All";
		}else{
			tableAlarmCode.$('input[type="checkbox"]').each(function(){
	            if(this.checked){
					if(str!="") str +=",";
					str += this.value
	            }
			}); 
		}
		if(str==""){
			showMsg("Warning", "Select rows to multi-select!");
			return;
		}
		$("#alarmCode").val(str);
		$('#modalAlarmCode').modal('hide');
	});
	
	
	tableAlarmCode = $('#dtAlarmCode').DataTable({
		"sDom": sDomNoControl,
		"oLanguage": oLanguage,
		"autoWidth" : true,
		"tableTools":tableTools,
		"scrollY" : "400px",
		"scrollX" : false,
		"scrollCollapse": true,
		"paging": false,
		"processing": true,
        "ajax": {
        	url: "/getAlarmCode",
        	type: "post",
        },
        'order': [[1, 'asc']],
        "columns": [
					{ "data": "alarmCode"},      
    				{ "data": "alarmCode"},       
    		        { "data": "alarmLevel"},	
    		        { "data": "rateLimitFlag" },	
    		        { "data": "alarmMsg" }, 	
    		    ],
    	'columnDefs': [	 
				{'targets': 0,
					'width':'40px',
					'searchable': false,
				    'orderable': false,
					'className': 'text-center',
					'render': function (data, type, full, meta){
						return '<input type="checkbox" name="id[]" value="' + data + '">'; 
					},
				},         
				{'targets': 1, 'className': 'text-center'},
				{'targets': 2, 'className': 'text-center', 'render': function (data, type, full, meta){ return getAlarmLevel(data); }},
				{'targets': 3, 'className': 'text-center', 'render': function (data, type, full, meta){ return getRateLimit(data); }},
				{'targets': 4, 'className': 'text-left'},
    	 ],
	});
	
	// click selectAll 
   $('#selectAll').on('click', function(){
      var rows = tableAlarmCode.rows({ 'search': 'applied' }).nodes();
      $('input[type="checkbox"]', rows).prop('checked', this.checked);
   });
	
	
	
} // pagefunction

function init(){
	
	// date rage setting
	$('#dateTime').daterangepicker({
		 timePicker: true, 
		 timePickerIncrement: 1,
		 locale: { 
			 format: 'YYYY-MM-DD HH:mm:ss' 
		 } 
	});
	
	// set range date
	var now = moment($("#systemDateTime").text(), 'YYYY.MM.DD HH:mm:ss');
	$('#dateTime').data('daterangepicker').setEndDate(now.format('YYYY.MM.DD HH:mm:ss'));
	$('#dateTime').data('daterangepicker').setStartDate(now.add(-1, 'hour').format('YYYY-MM-DD HH:mm:ss'));
	
	
	tableAlarmHistory = $('#dtAlarmHistory').DataTable({
		"sDom": sDom,
		"oLanguage": oLanguage,
		"autoWidth" : true,
		"tableTools":tableTools,
		"scrollY" : false,
		"scrollX" : false,
		"scrollCollapse": true,
		"paging": false,
		"processing": true,
        "ajax": {
        	url: "/getAlarmHistory",
        	type: "post",
        	data: function(d){
        		d.page=page;
        		d.pageSize=$("#pageSize").val();
//          		d.startDate = '2016-10-19 20:17:20'; 
//       			d.endDate = '2016-10-19 20:57:48';
    			d.startDate = $('#dateTime').data('daterangepicker').startDate.format('YYYY-MM-DD HH:mm:ss');
   				d.endDate = $('#dateTime').data('daterangepicker').endDate.format('YYYY-MM-DD HH:mm:ss');
     			d.arg = $("#alarmCode").val();
     			d.alarmLevel = $("#level").val();
     			
     			d.causeDescription = $('#causeDescription').val().trim();
        	}
        },
        'order': [[1, 'desc']],
        "columns": [
    				{ "data": "alarmLevel"},       
    		        { "data": "side"},	
    		        { "data": "blockName" },	
    		        { "data": "createDatetime" }, 	
    		        { "data": "alarmCode"}, 		
    		        { "data": "causeDescription" }, 	
    		    ],
    	'columnDefs': [	 
				{'targets': 0, 'className': 'text-center', 'render': function (data, type, full, meta){ return getAlarmLevel(data); }},
				{'targets': 1, 'className': 'text-center', 'render': function (data, type, full, meta){ return getSide(data); }},
				{'targets': 2, 'className': 'text-center'},
				{'targets': 3, 'className': 'text-center', 'render': function (data, type, full, meta){ return getDatetime(data); }},
				{'targets': 4, 'className': 'text-center'},
				{'targets': 5, 'className': 'text-center'},
    	 ],
    	 "initComplete": function(settings, json) {
    		 //$('#dtAlarmHistory tbody tr:eq(0)').click();
    		 showDetail();
    	 }
	});
	//	click row
	tableAlarmHistory.on( 'click', 'tr', function () {
		tableAlarmHistory.$('tr.selected').removeClass('selected');
		$(this).addClass('selected');
		
		showAlarmHistory();
	});
	//	dblclick row
	tableAlarmHistory.on( 'dblclick', 'tr', function () {
		tableAlarmHistory.$('tr.selected').removeClass('selected');
		$(this).addClass('selected');
		
		showAlarmHistory();
	});
	
	// pagenation, cnt
	tableAlarmHistory.on( 'xhr', function () {
	    var json = tableAlarmHistory.ajax.json();
	    showPagenation(json.vo);
// 		$("div.cnt").html("Subscribers Count: " + json.vo.subscriberCntReg + " / " + json.vo.subscriberCntAll);
// 		 $('#dateTime').data('daterangepicker').setStartDate(getDatetime(json.vo.date1));
// 		 $('#dateTime').data('daterangepicker').setEndDate(getDatetime(json.vo.date2));
	    
	} );
	
}	



$('body').append( $('<div>').load("/resources/html/common.html"));

loadScript("/resources/js/plugin/datatables/jquery.dataTables.min.js", function(){
	loadScript("/resources/scripts/common/dataTables.js", function(){
		loadScript("/resources/scripts/common/controls.js", pagefunction);
	});
});

function showDetail(){
	 var data = tableAlarmHistory.rows(0).data();
	 if(typeof data[0] !='undefined'){
		 $("#divAlarmHistoryDetail").show();
		 $('#dtAlarmHistory tbody tr:eq(0)').click();
	 }else{
		 $("#divAlarmHistoryDetail").hide();
	 }
}

function showAlarmHistory(){
	var data = tableAlarmHistory.rows('.selected').data();
	var item = data[0];
	
	
  	setControlCheck("frmAlarmHistory", "rateLimitProfile", (item.rateLimitProfile==0)?false:true, false); 
 	setControlInput("frmAlarmHistory", "rateLimitCategory", item.rateLimitCategory, false);
 	setControlInput("frmAlarmHistory", "alarmCauseParam", item.alarmCauseParam, false);
 	setControlInput("frmAlarmHistory", "alarmCauseRealValue", item.alarmCauseRealValue, false);
 	setControlInput("frmAlarmHistory", "protocol", getProtocol(item.protocol), false);
 	
 	setControlInput("frmAlarmHistory", "remoteIp", item.remoteIp, false);
 	setControlInput("frmAlarmHistory", "remotePort", item.remotePort, false);
 	setControlInput("frmAlarmHistory", "localIp", item.localIp, false);
 	setControlInput("frmAlarmHistory", "localPort", item.localPort, false);
 	
 	setControlInput("frmAlarmHistory", "fromUri", item.fromUri, false);
 	setControlInput("frmAlarmHistory", "toUri", item.toUri, false);
 	
 	
// 	setControlCheck("frmAlarmHistory", "ipkts", (item.ipkts==0)?false:true, false); 
// 	setControlRadio("frmAlarmHistory", "protocol", item.protocol, false);
	

 	

	
}

function getAlarmLevel(val){
	if(val==1) return "info";
	else if(val==2) return "minor";
	else if(val==3) return "major";
	else if(val==4) return "critical";
	else if(val==6) return "clear";
	else return "";
}

function getProtocol(val){
	if(val==1) return "udp";
	else if(val==2) return "tcp";
	else if(val==3) return "all";
	return "";
}

function getRateLimit(val){
	if(val==0) return "off";
	else if(val==1) return "on";
	else return "";
	
}


//--------------------- page ----------------------------------------------------------------------------------
function showPagenation(vo){ //page, totalPages, pageLength){
	var html = '';
	if(vo.page > vo.pageLength){
		html +='<li><a href="javascript:pageListener('+(vo.pageStart-1)+')" ><i class="fa fa-chevron-left"></i></a></li>';
	}
	for(var no=vo.pageStart; no<=vo.pageEnd; no++){
		if(no==vo.page){
			html+='<li class="active"><a href="javascript:void(0);">'+no+'</a></li>';
		}else{
			html+='<li><a href="javascript:pageListener('+no+')">'+no+'</a></li>';
		}
	}
	if(vo.totalPages > vo.pageLength && vo.pageEnd < vo.totalPages ){
		html+='<li><a href="javascript:pageListener('+(vo.pageEnd+1)+')"><i class="fa fa-chevron-right"></i></a></li>';
	}
	$("#ulPage").html(html);
}
function pageListener(no){
	page = no;
	tableAlarmHistory.ajax.reload(null, false);
	
	setTimeout(function(){
		// $('#dtAlarmHistory tbody tr:eq(0)').click();
		showDetail();
	},500);
	
}

function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,    
    function(m,key,value) {
      vars[key] = value;
    });
    return vars;
  }

</script>